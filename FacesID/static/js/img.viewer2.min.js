var waitForFinalEvent=function(){var t={};return function(o,e,i){i||(i="Don't call this twice without a uniqueId"),t[i]&&clearTimeout(t[i]),t[i]=setTimeout(o,e)}}();!function(t){t.widget("wgm.imgViewer2",{options:{zoomStep:.5,zoomMax:void 0,zoomable:!0,dragable:!0,onClick:t.noop,onReady:t.noop},_create:function(){var o=this;if(t(this.element).is("img"))o.img=o.element[0];else{var e=this.element.children()[0];t(e).is("img")?o.img=o.element.children()[0]:t.error("imgviewer plugin can only be applied to img elements")}var i=t(o.img);o.view=t("<div class='viewport' />").uniqueId().appendTo(i.parent());var a=t(o.view);o.map={},o.bounds={},o.ready=!1,o.resize=!1,i.one("load",function(){o.ready=!0;var t=i.width(),e=i.height(),n=i.position();o.offsetPadding={top:parseInt(i.css("padding-top"),10),left:parseInt(i.css("padding-left"),10),right:parseInt(i.css("padding-right"),10),bottom:parseInt(i.css("padding-bottom"),10)},o.offsetBorder={x:Math.round((i.outerWidth()-i.innerWidth())/2),y:Math.round((i.outerHeight()-i.innerHeight())/2)};var s=n.top+o.offsetBorder.y+o.offsetPadding.top,r=n.left+o.offsetBorder.x+o.offsetPadding.left;if(a.css({position:"absolute",overflow:"hidden",top:s+"px",left:r+"px",width:t+"px",height:e+"px"}),o.bounds=L.latLngBounds(L.latLng(0,0),L.latLng(o.img.naturalHeight,o.img.naturalWidth)),o.map=L.map(a.attr("id"),{crs:L.CRS.Simple,minZoom:-10,trackresize:!1,maxBoundsViscosity:1,attributionControl:!1,inertia:!1,zoomSnap:0,wheelPxPerZoomLevel:Math.round(36/o.options.zoomStep),zoomDelta:o.options.zoomStep}),o.zimg=L.imageOverlay(o.img.src,o.bounds).addTo(o.map),o.map.options.minZoom=o.map.getBoundsZoom(o.bounds,!1),o.map.fitBounds(o.bounds),o.bounds=o.map.getBounds(),o.map.setMaxBounds(o.bounds),null!==o.options.zoomMax){var m=o.leafletZoom(o.options.zoomMax);m<o.map.getZoom()&&o.map.setZoom(m),o.map.options.maxZoom=m}o.options.dragable||o.map.dragging.disable(),o.options.zoomable||(o.map.zoomControl.disable(),o.map.boxZoom.disable(),o.map.touchZoom.disable(),o.map.doubleClickZoom.disable(),o.map.scrollWheelZoom.disable()),o.map.on("click",function(t){null!==o.options.onClick&&o.options.onClick.call(o,t.originalEvent,o.eventToImg(t))}),o.map.on("zoomend",function(){o.options.zoomMax>=1&&this.getZoom()>this.options.zoomMax&&this.setZoom(this.options.zoomMax),o.resize||(o.bounds=o.map.getBounds())}),o.map.on("moveend",function(){o.resize||(o.bounds=o.map.getBounds())}),o.map.on("resize",function(){o.map.options.minZoom=-10,o.map.fitBounds(o.bounds,{animate:!1}),o.map.options.minZoom=o.map.getBoundsZoom(L.latLngBounds(L.latLng(0,0),L.latLng(o.img.naturalHeight,o.img.naturalWidth)),!0),o.map.options.maxZoom=o.leafletZoom(o.options.zoomMax),waitForFinalEvent(function(){o.resize=!1,o._view_resize(),o.map.options.minZoom=-10,o.map.fitBounds(o.bounds,{animate:!1}),o.map.options.minZoom=o.map.getBoundsZoom(L.latLngBounds(L.latLng(0,0),L.latLng(o.img.naturalHeight,o.img.naturalWidth)),!0),o.map.options.maxZoom=o.leafletZoom(o.options.zoomMax)},300,i[0].id)}),o.options.onReady.call(o)}).each(function(){this.complete&&t(this).trigger("load")}),t(window).resize(function(){o.ready&&(o.resize=!0,o._view_resize(),o.map.invalidateSize({animate:!1}))})},_view_resize:function(){if(this.ready){var o=t(this.view),e=t(this.img),i=e.width(),a=e.height(),n=e.position(),s=Math.round(n.top+this.offsetBorder.y+this.offsetPadding.top),r=Math.round(n.left+this.offsetBorder.x+this.offsetPadding.left);o.css({top:s+"px",left:r+"px",width:i+"px",height:a+"px"})}},destroy:function(){t(window).unbind("resize"),this.map.remove(),t(this.view).remove(),t.Widget.prototype.destroy.call(this)},_setOption:function(o,e){switch(o){case"zoomStep":if(parseFloat(e)<=0||isNaN(parseFloat(e)))return;break;case"zoomMax":if(parseFloat(e)<1||isNaN(parseFloat(e)))return}var i=t.ui.version.split(".");switch(i[0]>1||i[1]>8?this._super(o,e):t.Widget.prototype._setOption.apply(this,arguments),o){case"zoomStep":this.ready&&(this.map.options.zoomDelta=this.options.zoomStep,this.map.options.wheelPxPerZoomLevel=Math.round(60/this.options.zoomStep));break;case"zoomMax":this.ready&&(lzoom=this.leafletZoom(this.options.zoomMax),lzoom<this.map.getZoom()&&this.map.setZoom(lzoom),this.map.options.maxZoom=lzoom,this.map.fire("zoomend"));break;case"zoomable":this.options.zoomable?(this.map.zoomControl.enable(),this.map.boxZoom.enable(),this.map.touchZoom.enable(),this.map.doubleClickZoom.enable(),this.map.scrollWheelZoom.enable()):(this.map.zoomControl.disable(),this.map.boxZoom.disable(),this.map.touchZoom.disable(),this.map.doubleClickZoom.disable(),this.map.scrollWheelZoom.disable());break;case"dragable":this.options.dragable?this.map.dragging.enable():this.map.dragging.disable()}},isVisible:function(t,o){var e=this.getView();return!!e&&(t>=e.left&&t<=e.right&&o>=e.top&&o<=e.bottom)},leafletZoom:function(t){if(this.ready&&void 0!==t){var o=this.img,e=this.map,i=e.getZoom()||0,a=e.getSize(),n=o.naturalWidth,s=o.naturalHeight,r=L.latLng(s/t,n/t),m=L.latLng(0,0),l=e.project(r,i).subtract(e.project(m,i)),h=Math.min(a.x/l.x,-a.y/l.y);return e.getScaleZoom(h,i)}},getMap:function(){return this.ready?this.map:null},getZoom:function(){if(this.ready){var t=this.img,o=this.map,e=t.naturalWidth,i=t.naturalHeight,a=this.options.constraint,n=o.getBounds();return"width"==a?Math.max(1,e/(n.getEast()-n.getWest())):"height"==a?Math.max(1,i/(n.getNorth()-n.getSouth())):Math.max(1,(e/(n.getEast()-n.getWest())+i/(n.getNorth()-n.getSouth()))/2)}return null},setZoom:function(t){if(this.ready){t=Math.max(1,t),void 0===this.options.zoomMax||(t=Math.min(t,this.options.zoomMax));var o,e,i=this.img,a=this.map,n=i.naturalWidth,s=i.naturalHeight,r=this.options.constraint,m=a.getCenter(),l=a.getBounds();"width"==r?e=(o=n/t/2)*(l.getNorth()-l.getSouth())/(l.getEast()-l.getWest()):"height"==r?o=(e=s/t/2)*(l.getEast()-l.getWest())/(l.getNorth()-l.getSouth()):(o=n/t/2,e=s/t/2);var h=m.lng+o,p=m.lng-o,d=m.lat+e,g=m.lat-e;p<0?(h+=p,p=0):h>n&&(p-=h-n,h=n),g<0?(d+=g,g=0):d>s&&(g-=d-s,d=s),a.fitBounds(L.latLngBounds(L.latLng(g,p),L.latLng(d,h)),{animate:!1})}return this},getView:function(){if(this.ready){var t=this.img,o=t.naturalWidth,e=t.naturalHeight,i=this.map.getBounds();return{top:1-i.getNorth()/e,left:i.getWest()/o,bottom:1-i.getSouth()/e,right:i.getEast()/o}}return null},panTo:function(t,o){if(this.ready&&t>=0&&t<=1&&o>=0&&o<=1){var e=this.img,i=this.map,a=this.bounds,n=a.getEast(),s=a.getWest(),r=a.getNorth(),m=a.getSouth(),l=(n+s)/2,h=(r+m)/2,p=e.naturalWidth,d=e.naturalHeight,g=(1-o)*d,u=t*p;n+=u-l,r+=g-h,(s+=u-l)<0&&(n-=s,s=0),n>p&&(s-=n-p,n=p),(m+=g-h)<0&&(r-=m,m=0),r>d&&(m-=r-d,r=d),i.fitBounds(L.latLngBounds(L.latLng(m,s),L.latLng(r,n)),{animate:!1})}return this},eventToImg:function(t){if(this.ready){var o=this.img,e=o.naturalWidth,i=o.naturalHeight;return relx=t.latlng.lng/e,rely=1-t.latlng.lat/i,relx>=0&&relx<=1&&rely>=0&&rely<=1?{x:relx,y:rely}:null}return null},relposToLatLng:function(t,o){if(this.ready){var e=this.img,i=e.naturalWidth,a=e.naturalHeight;return L.latLng((1-o)*a,t*i)}return null},relposToImage:function(t){if(this.ready){var o=this.img,e=o.naturalWidth,i=o.naturalHeight;return{x:Math.round(t.x*e),y:Math.round(t.y*i)}}return null}})}(jQuery);